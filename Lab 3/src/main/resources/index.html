<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Scramble - Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .player-input-section {
            margin-bottom: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-group label {
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }

        .input-group input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 10px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-group button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .input-group button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-top: 3px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #28a745;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .color-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 3px solid;
        }

        .legend-box.my {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }

        .legend-box.other {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
        }

        .game-board {
            display: grid;
            gap: 6px;
            margin: 10px 0;
            justify-content: center;
        }

        .card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 3px 4px rgba(0, 0, 0, 0.1);
            min-width: 45px;
            min-height: 45px;
            position: relative;
        }

        .card:hover:not(:disabled) {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .card:active:not(:disabled) {
            transform: translateY(-2px);
        }

        .card.face-up {
            background: white;
            border: 3px solid #667eea;
            color: #333;
        }

        .card.my-card {
            background: white;
            border: 3px solid #28a745;
            color: #333;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.4);
        }

        .card.other-player {
            background: white;
            border: 3px solid #ffc107;
            color: #333;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.4);
        }

        .card.removed {
            background: #e9ecef;
            cursor: not-allowed;
            opacity: 0.3;
        }

        .card:disabled {
            cursor: not-allowed;
        }

        .player-label {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .message {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button.control-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button.control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.reset-btn {
            background: #dc3545;
            color: white;
        }

        button.reset-btn:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button.new-game-btn {
            background: #28a745;
            color: white;
        }

        button.new-game-btn:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }

            .card {
                font-size: 20px;
                min-width: 40px;
                min-height: 40px;
            }

            h1 {
                font-size: 18px;
            }

            .color-legend {
                gap: 15px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üß† Memory Scramble - Multiplayer</h1>

    <!-- Color Legend Only -->
    <div class="color-legend">
        <div class="legend-item">
            <div class="legend-box my"></div>
            <span>Your Cards</span>
        </div>
        <div class="legend-item">
            <div class="legend-box other"></div>
            <span>Other Players</span>
        </div>
    </div>

    <!-- Player Name Input -->
    <div class="player-input-section">
        <div class="input-group">
            <label for="playerNameInput">Player Name:</label>
            <input type="text" id="playerNameInput" placeholder="Enter your name" value="" />
            <button id="startGameBtn" onclick="startGame()">Join Game</button>
        </div>
    </div>

    <div class="info-bar">
        <div class="info-item">
            <div class="info-label">Player</div>
            <div class="info-value" id="playerName">
                -
                <span class="status-indicator" id="statusIndicator"></span>
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">Pairs Found</div>
            <div class="info-value" id="pairsFound">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">Moves</div>
            <div class="info-value" id="moveCount">0</div>
        </div>
    </div>

    <div id="message" class="message info">
        Enter your name and click "Join Game" to start
    </div>

    <div id="gameBoard" class="game-board">
        <div class="loading">Waiting to start...</div>
    </div>

    <div class="controls">
        <button class="control-btn reset-btn" id="resetBtn" onclick="resetGame()" disabled>Reset Game</button>
        <button class="control-btn new-game-btn" id="newGameBtn" onclick="newGame()" disabled>Leave Game</button>
    </div>
</div>

<script>
    // Configuration
    const SERVER_URL = 'http://localhost:8000';
    const WATCH_INTERVAL = 2000; // Check for updates every 2 seconds

    // Game state
    let currentPlayer = null;
    let boardState = null;
    let moveCount = 0;
    let pairsFound = 0;
    let isProcessing = false;
    let gameStarted = false;
    let watchInterval = null;
    let lastBoardState = '';

    // Start game with player name
    async function startGame() {
        const playerInput = document.getElementById('playerNameInput');
        const playerName = playerInput.value.trim();

        if (!playerName) {
            showMessage('Please enter a player name!', 'error');
            return;
        }

        currentPlayer = playerName;
        document.getElementById('playerName').innerHTML =
            playerName + '<span class="status-indicator active" id="statusIndicator"></span>';
        document.getElementById('startGameBtn').disabled = true;
        playerInput.disabled = true;

        gameStarted = true;
        moveCount = 0;
        pairsFound = 0;
        document.getElementById('moveCount').textContent = moveCount;
        document.getElementById('pairsFound').textContent = pairsFound;

        document.getElementById('resetBtn').disabled = false;
        document.getElementById('newGameBtn').disabled = false;

        await loadBoard();

        // Start watching for changes from other players
        startWatching();

        showMessage('üéÆ You joined the game! Start flipping cards or wait for other players.', 'success');
    }

    // Load current board state from server
    async function loadBoard() {
        if (!currentPlayer) {
            showMessage('Please join the game first!', 'error');
            return;
        }

        try {
            const url = `${SERVER_URL}/look/${encodeURIComponent(currentPlayer)}`;
            console.log('Fetching from:', url);

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }

            const boardText = await response.text();
            console.log('Received board:', boardText);

            lastBoardState = boardText;
            parseBoardState(boardText);
            renderBoard();
        } catch (error) {
            showMessage(`Failed to load game: ${error.message}. Is the server running on port 8000?`, 'error');
            console.error('Load error:', error);
        }
    }

    // Watch for board changes (multiplayer updates)
    function startWatching() {
        if (watchInterval) {
            clearInterval(watchInterval);
        }

        watchInterval = setInterval(async () => {
            if (!gameStarted || isProcessing) {
                return;
            }

            try {
                const url = `${SERVER_URL}/watch/${encodeURIComponent(currentPlayer)}`;
                const response = await fetch(url);

                if (response.ok) {
                    const boardText = await response.text();

                    // Only update if board changed
                    if (boardText !== lastBoardState) {
                        console.log('Board updated by another player!');
                        lastBoardState = boardText;
                        parseBoardState(boardText);
                        renderBoard();
                    }
                }
            } catch (error) {
                console.error('Watch error:', error);
            }
        }, WATCH_INTERVAL);
    }

    // Parse board state from server response
    function parseBoardState(boardText) {
        const lines = boardText.trim().split('\n');

        // First line: dimensions (e.g., "3x3")
        const [rows, cols] = lines[0].split('x').map(Number);

        // Parse each card position
        const cards = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            const parts = line.split(' ');

            let card = {
                state: parts[0], // "my", "up", "down", "none"
                value: parts.length > 1 ? parts.slice(1).join(' ') : null,
                row: Math.floor((i - 1) / cols),
                col: (i - 1) % cols
            };

            cards.push(card);
        }

        boardState = { rows, cols, cards };

        // Count pairs found (removed cards)
        pairsFound = cards.filter(c => c.state === 'none').length / 2;
        document.getElementById('pairsFound').textContent = pairsFound;
    }

    // Render the board UI
    function renderBoard() {
        const board = document.getElementById('gameBoard');
        board.innerHTML = '';
        board.style.gridTemplateColumns = `repeat(${boardState.cols}, 1fr)`;

        boardState.cards.forEach((card, index) => {
            const button = document.createElement('button');
            button.className = 'card';
            button.dataset.row = card.row;
            button.dataset.col = card.col;

            // Set card appearance based on state
            if (card.state === 'none') {
                button.classList.add('removed');
                button.textContent = '';
                button.disabled = true;
            } else if (card.state === 'my') {
                button.classList.add('my-card');
                button.textContent = card.value;
                button.disabled = true;

                // Add player label
                const label = document.createElement('span');
                label.className = 'player-label';
                label.textContent = 'YOU';
                button.appendChild(label);
            } else if (card.state === 'up') {
                button.classList.add('other-player');
                button.textContent = card.value;
                button.disabled = true;

                // Add "other" label
                const label = document.createElement('span');
                label.className = 'player-label';
                label.textContent = 'OTHER';
                button.appendChild(label);
            } else { // down
                button.textContent = '?';
            }

            button.onclick = () => flipCard(card.row, card.col);
            board.appendChild(button);
        });
    }

    // Flip a card
    async function flipCard(row, col) {
        if (isProcessing || !gameStarted) {
            return;
        }

        isProcessing = true;
        moveCount++;
        document.getElementById('moveCount').textContent = moveCount;

        try {
            const url = `${SERVER_URL}/flip/${encodeURIComponent(currentPlayer)}/${row},${col}`;
            console.log('Flipping:', url);

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }

            const result = await response.text();
            console.log('Flip result:', result);

            if (result.startsWith('ERROR:')) {
                showMessage(result, 'error');
                moveCount--;
                document.getElementById('moveCount').textContent = moveCount;
            } else {
                lastBoardState = result;
                parseBoardState(result);
                renderBoard();

                // Check game state
                const myCards = boardState.cards.filter(c => c.state === 'my');

                if (myCards.length === 2) {
                    if (myCards[0].value === myCards[1].value) {
                        showMessage('‚ú® Match found! Cards will be removed on next flip.', 'success');
                    } else {
                        showMessage('‚ùå No match. Cards will flip back on next flip.', 'info');
                    }
                } else if (myCards.length === 1) {
                    showMessage('First card flipped! Flip another to find a match.', 'info');
                } else {
                    showMessage('Click a card to flip it!', 'info');
                }

                // Check win condition
                const totalPairs = (boardState.rows * boardState.cols) / 2;
                if (pairsFound === totalPairs) {
                    showMessage(`üéâ Game Over! All pairs found in ${moveCount} moves!`, 'success');
                }
            }
        } catch (error) {
            showMessage(`Error: ${error.message}`, 'error');
            console.error('Flip error:', error);
        } finally {
            isProcessing = false;
        }
    }

    // Reset current game
    async function resetGame() {
        if (!gameStarted || !currentPlayer) {
            return;
        }

        if (!confirm('Reset the game for ALL players? This affects everyone!')) {
            return;
        }

        try {
            const url = `${SERVER_URL}/reset/${encodeURIComponent(currentPlayer)}`;
            console.log('Resetting:', url);

            const response = await fetch(url, { method: 'POST' });

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}`);
            }

            moveCount = 0;
            pairsFound = 0;
            document.getElementById('moveCount').textContent = moveCount;
            document.getElementById('pairsFound').textContent = pairsFound;

            await loadBoard();
            showMessage('üîÑ Game reset by ' + currentPlayer + '!', 'warning');
        } catch (error) {
            showMessage(`Failed to reset: ${error.message}`, 'error');
            console.error('Reset error:', error);
        }
    }

    // Leave game
    function newGame() {
        if (confirm('Leave the game? You can rejoin with a different name.')) {
            // Stop watching
            if (watchInterval) {
                clearInterval(watchInterval);
                watchInterval = null;
            }

            // Re-enable player input
            document.getElementById('playerNameInput').disabled = false;
            document.getElementById('playerNameInput').value = '';
            document.getElementById('startGameBtn').disabled = false;
            document.getElementById('playerName').innerHTML = '-';

            // Reset game state
            currentPlayer = null;
            gameStarted = false;
            moveCount = 0;
            pairsFound = 0;
            document.getElementById('moveCount').textContent = moveCount;
            document.getElementById('pairsFound').textContent = pairsFound;

            // Disable game controls
            document.getElementById('resetBtn').disabled = true;
            document.getElementById('newGameBtn').disabled = true;

            // Clear board
            document.getElementById('gameBoard').innerHTML = '<div class="loading">Waiting to start...</div>';
            showMessage('Enter your name and click "Join Game" to start', 'info');
        }
    }

    // Show message to user
    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (watchInterval) {
            clearInterval(watchInterval);
        }
    });
</script>
</body>
</html>
